<!DOCTYPE html>
<!-- cribbed extensively from https://www.google.com/intl/en/chrome/demos/speech.html -->
<html lang="en" id="mac"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <title>
      Speech-to-Pictogram
    </title>

    <style>
    body, html {
      height: 100%;
    }

    body {
      padding: 0;
      margin: 0;
      background-color: black;
      color: #fff;
    }

    .interim {
      color: #999;
    }

    .carousel {
      height: 100vh;
      text-align: center;
      width: 100%;
    }

    .carousel-cell {
      text-align: center;
      height: 100vh;
      margin: 0;
      width: 100%;
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center center;
    }

    .carousel-cell img {
      max-width: 100%;
      height: auto;
    }

    .caption {
      text-align: center;
      text-transform: uppercase;
      margin-top: 0.5em;
      position: absolute;
      top: 6%;
      left: 0;
      right: 0;
    }

    .caption span {
      font-family: "League Gothic", LeagueGothic, Helvetica;
      font-size: 15vh;
      background-color: rgba(0,0,0,0.5);
      color: white;
      padding: 0.2em;
      display: inline-block;
    }

    #captioned-text {
      text-align: left;
      position: absolute;
      top: 80%;
      left: 10%;
      right: 10%;
      z-index: 1000;
      font-size: 5vh;
      font-family: "Roboto Slab", Helvetica;
      opacity: 0.9;
      overflow-y: scroll;
    }

    #captioned-text::-webkit-scrollbar { 
      display: none; 
    }

    #captioned-text p {
      display: inline-block;
      background-color: black;
      color: white;
      padding: 0.2em;
    }

    #interim_text {
      color: rgb(200,200,200);
    }

    </style>

    <!-- Hide referrer so we don't get dinged for hotlinking directly to images -->
    <meta name="referrer" content="no-referrer" />

    <!-- Load jQuery -->
    <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>

    <!-- Load NLP -->
    <script src="compromise/builds/compromise.min.js"></script>

    <!-- Load Slideshow -->
    <link rel="stylesheet" href="https://unpkg.com/flickity@2/dist/flickity.min.css">
    <script src="https://unpkg.com/flickity@2/dist/flickity.pkgd.min.js"></script>


    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab" rel="stylesheet">

  </head>

  <body id="grid" onload="start(event)">

    <div id="carousel" class="carousel">
      <div class="carousel-cell" style="background-image:url('http://printablecalendartemplates.com/wp-content/uploads/2017/03/81a888a2ea68188a95f60475746e8403.jpg');"><div class="caption"><span>Improvisational PowerPoint</span></div></div>
    </div>

    <div id="captioned-text">
      <p><span class="final" id="final_text"></span> <span class="interim" id="interim_text"></span></p>
    </div>

<script>

// carousel

$('#carousel').flickity({
  // options
  cellAlign: 'center',
  lazyLoad: true,
  imagesLoaded: true,
  setGallerySize: false
});

var final_transcript = '';
var recognizing = false;
var start_timestamp;
var all_phrases = [];

function start(event) {
  if (recognizing) {
    recognition.stop();
    return;
  }
  final_transcript = '';
  recognition.lang = 'en-US';
  recognition.start();
  ignore_onend = false;
}


if (!('webkitSpeechRecognition' in window)) {
  $('.info_upgrade').show();
} else {

  var recognition = new webkitSpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onstart = function() {
    recognizing = true;
  };

  recognition.onerror = function(event) {
  };

  recognition.onend = function() {
    recognizing = false;
    // start again!
    start();
  };

  recognition.onresult = function(event) {
    var interim_transcript = '';

    if (typeof(event.results) == 'undefined') {
      recognition.onend = null;
      recognition.stop();
      // we have a problem, deliver upgrade message
        $('.info_upgrade').show();
      return;
    }

    for (var i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {

        var class_name = event.results[i][0].transcript.replace(/\s+/g, '-').toLowerCase(); 

        final_transcript += '<span class="word ' + class_name + '">' + event.results[i][0].transcript + '</span>';
        debounce( function(){ process_new_phrase( event.results[i][0].transcript ); }, 350, true )();

      } else {

        var confidence = event.results[i][0].confidence;
        var phrase = event.results[i][0].transcript; 

        interim_transcript += event.results[i][0].transcript;        
        debounce( function(){ process_new_phrase( interim_transcript ); }, 350, false )();  

      }
    }
    
    $('#final_text').html(final_transcript);
    $('#interim_text').html(interim_transcript);

    var caption_text = document.getElementById('captioned-text');
    caption_text.scrollTop = caption_text.scrollHeight;


  };
}

function process_new_phrase( phrase ) {

  console.log('processing', phrase);

  var term = filter_word( phrase );
  if ( !term ) return false;

  if ( !deduplicate_term( term ) ) return false;

  // add this term to the list
  all_phrases.push( term );

  console.log('finding image:', term, 'via phrase', phrase);

  $.getJSON( "https://api.flickr.com/services/rest/", 
            { method: 'flickr.photos.search',
              api_key: '43cc03eb3467195ae9b8ec35d994d379',
              text: term,
              sort: 'relevance',
              safe_search: 1,
              per_page: 1,
              format: 'json',
              nojsoncallback: 1
            },
            function( data ) {
                                if (typeof data.photos !== 'undefined') { 
                                  var photo = data.photos.photo[0];

                                  var url = "https://farm" + photo.farm + ".staticflickr.com/" + photo.server + "/" + photo.id + "_" + photo.secret + "_z.jpg";

                                  // add this to the slideshow
                                  add_image(url, term);
                                }
                              }
            );


  // Google Custom Search Engine option

  // var google_api = 'xxx';
  // var google_cse = 'xxx';

  // $.getJSON( "https://www.googleapis.com/customsearch/v1", 
  //           { q: term,
  //             cx: google_cse,
  //             imgSize: 'xlarge',
  //             safe: 'high',
  //             searchType: 'image',
  //             key: google_api,
  //             num: 1
  //           },
  //           function( data ) {
  //   if (typeof data.items !== 'undefined') { 
  //     var url = data.items[0].link;
  //     // add this to the slideshow
  //     add_image(url, term);
  //   }
  // });

}


// Debounce: Returns a function, that, as long as it continues to be invoked, will not
// be triggered. The function will be called after it stops being called for
// N milliseconds. If `immediate` is passed, trigger the function on the
// leading edge, instead of the trailing.

var timeout;

function debounce(func, wait, immediate) {
  return function() {
    var context = this, args = arguments;
    var later = function() {
      timeout = null;
      if (!immediate) func.apply(context, args);
    };
    var callNow = immediate && !timeout;
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
    if (callNow) func.apply(context, args);
  };
};


function filter_word( phrase ) {

  if (!phrase) return false;

  // get the topics, then nouns from the phrase
  var phrases = nlp(phrase);
  if ( !phrases ) return phrase;

  var topics = phrases.topics().out('array');
  if ( topics.length ) return topics.slice(-1)[0]; // return the final element of the array
  
  var nouns = phrases.nouns().out('array');
  if ( nouns.length ) return nouns.slice(-1)[0];

  return phrase;
}


function deduplicate_term( term ) {

  // must be at least three characters
  if (term.length < 3) return false;

  // no contractions
  if (term.indexOf("'") !== -1) return false;

  // review the last few phrases
  var count = all_phrases.length;

  if ( count > 6 ) {
    var review_count = Math.ceil( count / 3 );
  } else {
    var review_count = count;
  }

  for ( var i=count-1; i>-1; i-- ) {

    if ( all_phrases[i] == term || all_phrases[i].indexOf(term) === 0 ) {
      // there's a recent match; no-go
      return false;
    }
  }
  return true;
}


function add_image(url, phrase) {
  
  var $slide = $('<div class="carousel-cell" style="background-image: url(' + url + ');"><div class="caption"><span>' + phrase + '</span></div></div>');
  $('#carousel').flickity('append', $slide).flickity('next');

}


$( document ).keypress(function( event ) {
  // console.log(event.which);
  if ( event.which == 99 ) {
     $('#captioned-text').fadeToggle();
  }
});

</script>

</body></html>
